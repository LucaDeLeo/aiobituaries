# Epic 4: Category System & Filtering - Technical Specification

**Epic ID:** 4
**Epic Title:** Category System & Filtering
**Date:** 2025-11-30
**Author:** Generated by Epic Tech Context Specialist

---

## 1. Epic Overview

### 1.1 Description

Epic 4 implements the category system and filtering functionality that enables users to explore obituaries by type and share filtered views. The four categories (Capability Doubt, Market/Bubble, AGI Skepticism, Dismissive Framing) each have distinct visual identities and allow users to focus on specific types of AI skepticism claims.

The core innovation is URL-based state management using nuqs, which enables shareable filtered views. When a user filters to "market" category and shares the URL, recipients see the same filtered state - critical for the site's utility in debates and discussions.

### 1.2 Business Value and Goals

- **Focused Exploration:** Users can isolate specific types of skepticism (e.g., "show me only market bubble claims")
- **Shareability:** Filtered URLs enable targeted sharing in debates ("here are all the market crash predictions: aiobituaries.com/?cat=market")
- **Category Distribution Insight:** Visual breakdown chart shows which types of skepticism are most common
- **Pattern Discovery:** Filtering reveals patterns within categories (e.g., capability doubts cluster around benchmark releases)
- **Multi-Category Analysis:** Users can combine categories to explore relationships

### 1.3 Functional Requirements Covered

| FR ID | Requirement | Story |
|-------|-------------|-------|
| FR14 | System categorizes obituaries into four types: Capability doubt, Market/bubble claims, AGI skepticism, Dismissive framing | 4.1 |
| FR15 | Users can filter obituaries by one or more categories | 4.2 |
| FR16 | System displays category breakdown visualization (chart showing distribution) | 4.5 |
| FR17 | Filtered view updates timeline and list displays in real-time | 4.4 |
| FR18 | System persists filter state in URL for shareability | 4.3 |

### 1.4 Scope

**In-Scope (5 Stories):**
- Story 4.1: Category Data Model (constants, types, utilities)
- Story 4.2: Category Filter Bar (UI component with toggle pills)
- Story 4.3: URL State with nuqs (shareable filter state)
- Story 4.4: Filter Effect on Timeline (visual filtering of dots)
- Story 4.5: Category Breakdown Chart (distribution visualization)

**Out-of-Scope:**
- Date range filtering (mentioned in architecture, deferred to future)
- Search functionality (Growth feature per PRD)
- Category-specific pages with contextual Y-axes (already exist from Epic 1)
- Category editing in Sanity (CMS configuration, not app code)

### 1.5 Dependencies and Prerequisites

**Epic Dependencies:**
- Epic 1 complete (Foundation)
  - Design system with category colors defined
  - Sanity CMS with categories field on obituaries
- Epic 2 complete (Core Content Display)
  - Obituary types with categories array
  - Homepage layout with count display
- Epic 3 complete (Timeline Visualization)
  - ScatterPlot component accepting filter props
  - ScatterPoint with category-based coloring

**External Dependencies:**
- nuqs 2.x for URL state management
- shadcn/ui components (ToggleGroup or custom pills)
- Visx for category chart (optional - can use CSS)

---

## 2. Technical Context

### 2.1 Relevant Architecture Decisions

| ADR | Decision | Impact on Epic 4 |
|-----|----------|------------------|
| ADR-004 | URL State with nuqs | Filter state persisted in URL params (?cat=market,agi) |
| - | Category Colors | Four distinct colors defined in CSS variables |
| - | Server/Client Split | Server fetches all data, client filters for display |

### 2.2 Technology Stack for Epic 4

| Technology | Version | Purpose in Epic 4 |
|------------|---------|-------------------|
| nuqs | 2.x | URL-synced state management |
| shadcn/ui | 3.5.0 | Toggle components, potential chart primitives |
| Visx | 3.12.0 | Category breakdown chart (optional) |
| React | 19.x | Client components for filtering |
| TypeScript | 5.x | Type-safe category definitions |

### 2.3 Project Structure (Epic 4 Additions)

```
src/
├── app/
│   ├── layout.tsx                    # Modify: Add NuqsAdapter provider
│   └── page.tsx                      # Modify: Pass filter state to components
│
├── components/
│   ├── filters/
│   │   ├── category-filter.tsx       # Create: Filter bar with toggle pills
│   │   └── category-pill.tsx         # Create: Individual filter pill
│   │
│   └── visualization/
│       ├── category-chart.tsx        # Create: Distribution chart
│       ├── scatter-plot.tsx          # Modify: Accept activeCategories prop
│       └── scatter-point.tsx         # Modify: Handle filtered state
│
├── lib/
│   ├── constants/
│   │   └── categories.ts             # Create: Category definitions
│   │
│   └── hooks/
│       └── use-filters.ts            # Create: nuqs filter state hook
│
└── types/
    └── obituary.ts                   # Verify: Category type exists
```

### 2.4 Integration Points

```
Epic 4 Filter Data Flow:

┌─────────────────────────────────────────────────────────────────┐
│                       URL Query Params                           │
│                     ?cat=market,agi                              │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                     NuqsAdapter (layout.tsx)                      │
│                                                                   │
│  - Parses URL on load                                            │
│  - Syncs state changes back to URL                               │
│  - Server-compatible via searchParams                            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                     useFilters() Hook                             │
│                                                                   │
│  const [categories, setCategories] = useQueryState(              │
│    'cat',                                                         │
│    parseAsArrayOf(parseAsString).withDefault([])                 │
│  )                                                                │
│                                                                   │
│  Returns: { categories, setCategories, toggleCategory }          │
└────────────────────────────┬────────────────────────────────────┘
                             │
              ┌──────────────┼──────────────┐
              │              │              │
              ▼              ▼              ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  CategoryFilter │  │   ScatterPlot   │  │  CategoryChart  │
│                 │  │                 │  │                 │
│  - Shows pills  │  │  - Receives     │  │  - Shows dist   │
│  - Toggle state │  │    categories[] │  │  - Click = filter│
│  - Updates URL  │  │  - Fades dots   │  │                 │
└─────────────────┘  └─────────────────┘  └─────────────────┘

Filter Flow Detail:
1. User clicks "Market" pill in CategoryFilter
2. toggleCategory('market') updates nuqs state
3. URL changes to ?cat=market (shallow, no reload)
4. useFilters() re-renders all consuming components
5. ScatterPlot receives categories=['market']
6. Non-matching dots fade to 20% opacity
7. CategoryChart updates to highlight filtered category
```

---

## 3. Data Models

### 3.1 Category Type Definitions

```typescript
// src/types/obituary.ts (verify existing)

/**
 * The four category types for obituaries.
 * These map to Sanity CMS values and CSS variable names.
 */
export type Category = 'market' | 'capability' | 'agi' | 'dismissive'

/**
 * Full category definition with metadata.
 */
export interface CategoryDefinition {
  /** Unique ID matching Sanity value */
  id: Category
  /** Human-readable label */
  label: string
  /** Short description for tooltips */
  description: string
  /** Hex color value (matches CSS variable) */
  color: string
  /** CSS variable name for color */
  colorVar: string
}
```

### 3.2 Category Constants

```typescript
// src/lib/constants/categories.ts

import type { Category, CategoryDefinition } from '@/types/obituary'

/**
 * Complete category definitions.
 *
 * IMPORTANT: Colors must match CSS variables in globals.css:
 *   --category-capability: #C9A962
 *   --category-market: #7B9E89
 *   --category-agi: #9E7B7B
 *   --category-dismissive: #7B7B9E
 */
export const CATEGORIES: Record<Category, CategoryDefinition> = {
  capability: {
    id: 'capability',
    label: 'Capability Doubt',
    description: 'Claims AI cannot do specific tasks',
    color: '#C9A962',
    colorVar: '--category-capability',
  },
  market: {
    id: 'market',
    label: 'Market/Bubble',
    description: 'AI is overhyped or a bubble',
    color: '#7B9E89',
    colorVar: '--category-market',
  },
  agi: {
    id: 'agi',
    label: 'AGI Skepticism',
    description: 'AGI is impossible or very far away',
    color: '#9E7B7B',
    colorVar: '--category-agi',
  },
  dismissive: {
    id: 'dismissive',
    label: 'Dismissive Framing',
    description: 'Casual dismissal or mockery of AI',
    color: '#7B7B9E',
    colorVar: '--category-dismissive',
  },
} as const

/**
 * Ordered array of categories for consistent display.
 */
export const CATEGORY_ORDER: Category[] = [
  'capability',
  'market',
  'agi',
  'dismissive',
]

/**
 * Get category definition by ID.
 */
export function getCategory(id: Category): CategoryDefinition {
  return CATEGORIES[id]
}

/**
 * Get category color by ID.
 */
export function getCategoryColor(id: Category): string {
  return CATEGORIES[id].color
}

/**
 * Get category label by ID.
 */
export function getCategoryLabel(id: Category): string {
  return CATEGORIES[id].label
}

/**
 * Get all categories as array.
 */
export function getAllCategories(): CategoryDefinition[] {
  return CATEGORY_ORDER.map(id => CATEGORIES[id])
}

/**
 * Check if a value is a valid category.
 */
export function isValidCategory(value: string): value is Category {
  return value in CATEGORIES
}
```

### 3.3 Filter State Types

```typescript
// src/lib/hooks/use-filters.ts (types section)

import type { Category } from '@/types/obituary'

/**
 * Filter state returned by useFilters hook.
 */
export interface FilterState {
  /** Currently active categories (empty = show all) */
  categories: Category[]
  /** Set categories directly */
  setCategories: (categories: Category[]) => void
  /** Toggle a single category */
  toggleCategory: (category: Category) => void
  /** Clear all filters (show all) */
  clearFilters: () => void
  /** Check if any filters are active */
  hasActiveFilters: boolean
  /** Check if specific category is active */
  isCategoryActive: (category: Category) => boolean
}
```

### 3.4 Category Chart Types

```typescript
// src/components/visualization/category-chart.tsx (types section)

import type { Category } from '@/types/obituary'

/**
 * Category count for chart display.
 */
export interface CategoryCount {
  category: Category
  count: number
  percentage: number
}

/**
 * Props for CategoryChart component.
 */
export interface CategoryChartProps {
  /** Obituaries to count by category */
  obituaries: { categories: Category[] }[]
  /** Active filters (for highlighting) */
  activeCategories?: Category[]
  /** Callback when category is clicked */
  onCategoryClick?: (category: Category) => void
}
```

---

## 4. Component Specifications

### 4.1 CategoryFilter (Filter Bar)

**File:** `src/components/filters/category-filter.tsx`

**Purpose:** Floating filter bar with toggle pills for each category. Positioned at bottom center of viewport, always visible.

**Required data-testid attributes:**
- `data-testid="category-filter"` - on the main container
- `data-testid="category-pill-{category}"` - on each pill (e.g., "category-pill-market")
- `data-testid="filter-all-button"` - on the "All" button

**Props:**
```typescript
interface CategoryFilterProps {
  /** Active categories from filter state */
  activeCategories: Category[]
  /** Callback to toggle category */
  onToggle: (category: Category) => void
  /** Callback to show all */
  onShowAll: () => void
  /** Optional className for container */
  className?: string
}
```

**Visual Design:**
- Position: Fixed, bottom: 24px, centered horizontally
- Background: `--bg-secondary` with `backdrop-filter: blur(8px)`
- Border: 1px `--border`
- Border radius: 9999px (full pill shape)
- Padding: 8px 16px
- Shadow: subtle drop shadow

**Pill Design:**
```
┌─────────────────────────────────────────────────────────────┐
│  [All]  [● Capability]  [● Market]  [● AGI]  [● Dismissive] │
└─────────────────────────────────────────────────────────────┘
```

**Pill States:**
| State | Background | Text | Dot |
|-------|------------|------|-----|
| Inactive | transparent | `--text-secondary` | Category color, 50% opacity |
| Active | Category color (20% opacity) | `--text-primary` | Category color, 100% opacity |
| Hover | `--bg-tertiary` | `--text-primary` | Category color |

**Implementation:**
```tsx
'use client'

import { motion } from 'motion/react'
import { CATEGORY_ORDER, getCategory } from '@/lib/constants/categories'
import { CategoryPill } from './category-pill'
import type { Category } from '@/types/obituary'

export function CategoryFilter({
  activeCategories,
  onToggle,
  onShowAll,
  className,
}: CategoryFilterProps) {
  const showingAll = activeCategories.length === 0

  return (
    <motion.div
      data-testid="category-filter"
      className={cn(
        'fixed bottom-6 left-1/2 -translate-x-1/2',
        'flex items-center gap-2 px-4 py-2',
        'bg-[--bg-secondary]/80 backdrop-blur-md',
        'border border-[--border] rounded-full',
        'shadow-lg',
        className
      )}
      initial={{ y: 20, opacity: 0 }}
      animate={{ y: 0, opacity: 1 }}
      transition={{ delay: 0.3 }}
    >
      <button
        data-testid="filter-all-button"
        onClick={onShowAll}
        className={cn(
          'px-3 py-1.5 rounded-full text-sm font-medium transition-colors',
          showingAll
            ? 'bg-[--accent-primary]/20 text-[--text-primary]'
            : 'text-[--text-secondary] hover:text-[--text-primary]'
        )}
      >
        All
      </button>

      {CATEGORY_ORDER.map(categoryId => (
        <CategoryPill
          key={categoryId}
          category={getCategory(categoryId)}
          isActive={activeCategories.includes(categoryId)}
          onClick={() => onToggle(categoryId)}
        />
      ))}
    </motion.div>
  )
}
```

### 4.2 CategoryPill (Individual Filter)

**File:** `src/components/filters/category-pill.tsx`

**Purpose:** Individual toggle pill with category dot and label.

**Props:**
```typescript
interface CategoryPillProps {
  category: CategoryDefinition
  isActive: boolean
  onClick: () => void
}
```

**Implementation:**
```tsx
'use client'

import { motion } from 'motion/react'
import type { CategoryDefinition } from '@/types/obituary'

export function CategoryPill({
  category,
  isActive,
  onClick,
}: CategoryPillProps) {
  return (
    <motion.button
      data-testid={`category-pill-${category.id}`}
      onClick={onClick}
      className={cn(
        'flex items-center gap-2 px-3 py-1.5 rounded-full',
        'text-sm font-medium transition-colors',
        'min-h-[44px]', // Touch target
        isActive
          ? 'text-[--text-primary]'
          : 'text-[--text-secondary] hover:text-[--text-primary]'
      )}
      style={{
        backgroundColor: isActive ? `${category.color}20` : 'transparent',
      }}
      whileHover={{ scale: 1.02 }}
      whileTap={{ scale: 0.98 }}
    >
      <span
        className="w-2 h-2 rounded-full"
        style={{
          backgroundColor: category.color,
          opacity: isActive ? 1 : 0.5,
        }}
      />
      <span>{category.label}</span>
    </motion.button>
  )
}
```

### 4.3 useFilters Hook

**File:** `src/lib/hooks/use-filters.ts`

**Purpose:** nuqs-based hook for URL-synced filter state.

**Implementation:**
```typescript
'use client'

import { useQueryState, parseAsArrayOf, parseAsStringLiteral } from 'nuqs'
import { useCallback, useMemo } from 'react'
import type { Category } from '@/types/obituary'
import { isValidCategory, CATEGORY_ORDER } from '@/lib/constants/categories'

const categoryParser = parseAsArrayOf(
  parseAsStringLiteral(CATEGORY_ORDER)
).withDefault([])

export interface FilterState {
  categories: Category[]
  setCategories: (categories: Category[]) => void
  toggleCategory: (category: Category) => void
  clearFilters: () => void
  hasActiveFilters: boolean
  isCategoryActive: (category: Category) => boolean
}

export function useFilters(): FilterState {
  const [categories, setCategories] = useQueryState('cat', categoryParser)

  const toggleCategory = useCallback((category: Category) => {
    setCategories(prev => {
      if (prev.includes(category)) {
        return prev.filter(c => c !== category)
      }
      return [...prev, category]
    })
  }, [setCategories])

  const clearFilters = useCallback(() => {
    setCategories([])
  }, [setCategories])

  const hasActiveFilters = useMemo(() => {
    return categories.length > 0
  }, [categories])

  const isCategoryActive = useCallback((category: Category) => {
    return categories.length === 0 || categories.includes(category)
  }, [categories])

  return {
    categories,
    setCategories,
    toggleCategory,
    clearFilters,
    hasActiveFilters,
    isCategoryActive,
  }
}
```

### 4.4 NuqsAdapter Setup

**File:** `src/app/layout.tsx` (modification)

**Purpose:** Add nuqs provider for URL state management.

**Required Changes:**
```tsx
import { NuqsAdapter } from 'nuqs/adapters/next/app'

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <NuqsAdapter>
          <Header />
          <main>{children}</main>
          <Footer />
        </NuqsAdapter>
      </body>
    </html>
  )
}
```

### 4.5 ScatterPlot Filter Integration

**File:** `src/components/visualization/scatter-plot.tsx` (modification)

**Purpose:** Accept and apply category filters to visualization.

**Props Addition:**
```typescript
interface ScatterPlotProps {
  data: ObituarySummary[]
  mode?: YAxisMode
  activeCategories?: Category[]  // NEW: Active filters
  onSelect?: (obituary: ObituarySummary) => void
  height?: number
}
```

**Implementation Changes:**
```tsx
export function ScatterPlot({
  data,
  mode = 'spread',
  activeCategories = [],  // Empty = show all
  onSelect,
  height = 400,
}: ScatterPlotProps) {
  // Determine if each point should be filtered
  const isPointVisible = useCallback((obituary: ObituarySummary) => {
    if (activeCategories.length === 0) return true
    return obituary.categories.some(cat => activeCategories.includes(cat))
  }, [activeCategories])

  return (
    <svg>
      {data.map(obituary => (
        <ScatterPoint
          key={obituary._id}
          obituary={obituary}
          x={xScale(new Date(obituary.date))}
          y={getYValue(obituary, mode) * height}
          color={getCategoryColor(obituary.categories[0] || 'capability')}
          isFiltered={isPointVisible(obituary)}  // Controls opacity
          isHovered={hoveredId === obituary._id}
          isClustered={isPointClustered(obituary._id, clusters)}
          onMouseEnter={() => setHoveredId(obituary._id)}
          onMouseLeave={() => setHoveredId(null)}
          onClick={() => handleClick(obituary)}
        />
      ))}
    </svg>
  )
}
```

### 4.6 ScatterPoint Filter State

**File:** `src/components/visualization/scatter-point.tsx` (modification)

**Purpose:** Visual handling of filtered/unfiltered state.

**Implementation Changes:**
```tsx
export function ScatterPoint({
  obituary,
  x,
  y,
  color,
  isFiltered,  // true = visible, false = faded
  isHovered,
  isClustered,
  onMouseEnter,
  onMouseLeave,
  onClick,
}: ScatterPointProps) {
  // Determine visual state
  const opacity = useMemo(() => {
    if (!isFiltered) return 0.2  // Faded when filtered out
    if (isHovered) return 1
    return 0.8
  }, [isFiltered, isHovered])

  const pointerEvents = isFiltered ? 'auto' : 'none'
  const filter = isFiltered && isHovered
    ? 'drop-shadow(0 0 6px currentColor)'
    : isFiltered
    ? 'drop-shadow(0 0 3px currentColor)'
    : 'none'  // No glow when filtered out

  return (
    <motion.circle
      cx={x}
      cy={y}
      r={7}
      fill={color}
      style={{
        opacity,
        filter,
        pointerEvents,
        cursor: isFiltered ? 'pointer' : 'default',
      }}
      animate={{ opacity }}
      transition={{ duration: 0.2 }}
      whileHover={isFiltered ? { scale: 1.3 } : undefined}
      onMouseEnter={isFiltered ? onMouseEnter : undefined}
      onMouseLeave={isFiltered ? onMouseLeave : undefined}
      onClick={isFiltered ? onClick : undefined}
    />
  )
}
```

### 4.7 CategoryChart

**File:** `src/components/visualization/category-chart.tsx`

**Purpose:** Display category distribution as horizontal bar chart.

**Required data-testid attributes:**
- `data-testid="category-chart"` - on the main container
- `data-testid="category-bar-{category}"` - on each bar

**Props:**
```typescript
interface CategoryChartProps {
  obituaries: { categories: Category[] }[]
  activeCategories?: Category[]
  onCategoryClick?: (category: Category) => void
}
```

**Design:**
```
Capability Doubt   ███████████████████░░░░░░  65 (42%)
Market/Bubble      ████████████░░░░░░░░░░░░░  48 (31%)
AGI Skepticism     ██████░░░░░░░░░░░░░░░░░░░  28 (18%)
Dismissive         ███░░░░░░░░░░░░░░░░░░░░░░  14 (9%)
```

**Implementation:**
```tsx
'use client'

import { useMemo } from 'react'
import { motion } from 'motion/react'
import { CATEGORY_ORDER, getCategory } from '@/lib/constants/categories'
import type { Category } from '@/types/obituary'

interface CategoryChartProps {
  obituaries: { categories: Category[] }[]
  activeCategories?: Category[]
  onCategoryClick?: (category: Category) => void
}

export function CategoryChart({
  obituaries,
  activeCategories = [],
  onCategoryClick,
}: CategoryChartProps) {
  // Count obituaries per category
  const counts = useMemo(() => {
    const result: Record<Category, number> = {
      capability: 0,
      market: 0,
      agi: 0,
      dismissive: 0,
    }

    obituaries.forEach(ob => {
      ob.categories.forEach(cat => {
        if (cat in result) {
          result[cat]++
        }
      })
    })

    return result
  }, [obituaries])

  const total = obituaries.length
  const maxCount = Math.max(...Object.values(counts))

  // Sort by count descending
  const sortedCategories = useMemo(() => {
    return [...CATEGORY_ORDER].sort((a, b) => counts[b] - counts[a])
  }, [counts])

  return (
    <div
      data-testid="category-chart"
      className="space-y-3"
    >
      {sortedCategories.map((categoryId, index) => {
        const category = getCategory(categoryId)
        const count = counts[categoryId]
        const percentage = total > 0 ? Math.round((count / total) * 100) : 0
        const barWidth = maxCount > 0 ? (count / maxCount) * 100 : 0
        const isActive = activeCategories.length === 0 || activeCategories.includes(categoryId)

        return (
          <motion.button
            key={categoryId}
            data-testid={`category-bar-${categoryId}`}
            className={cn(
              'w-full text-left group',
              'transition-opacity',
              isActive ? 'opacity-100' : 'opacity-40'
            )}
            onClick={() => onCategoryClick?.(categoryId)}
            initial={{ opacity: 0, x: -20 }}
            animate={{ opacity: isActive ? 1 : 0.4, x: 0 }}
            transition={{ delay: index * 0.1 }}
          >
            <div className="flex justify-between mb-1">
              <span className="text-sm text-[--text-secondary] group-hover:text-[--text-primary]">
                {category.label}
              </span>
              <span className="text-sm text-[--text-muted]">
                {count} ({percentage}%)
              </span>
            </div>
            <div className="h-2 bg-[--bg-tertiary] rounded-full overflow-hidden">
              <motion.div
                className="h-full rounded-full"
                style={{ backgroundColor: category.color }}
                initial={{ width: 0 }}
                animate={{ width: `${barWidth}%` }}
                transition={{ duration: 0.5, delay: index * 0.1 }}
              />
            </div>
          </motion.button>
        )
      })}
    </div>
  )
}
```

---

## 5. Page Integration

### 5.1 Homepage Integration

**File:** `src/app/page.tsx` (modification)

**Purpose:** Wire up filter state to all components.

**Implementation:**
```tsx
import { getObituaries } from '@/lib/sanity/queries'
import { ScatterPlot } from '@/components/visualization/scatter-plot'
import { CategoryFilter } from '@/components/filters/category-filter'
import { CategoryChart } from '@/components/visualization/category-chart'
import { HomePageClient } from './page-client'

export default async function HomePage() {
  const obituaries = await getObituaries()

  return (
    <HomePageClient obituaries={obituaries} />
  )
}
```

**File:** `src/app/page-client.tsx` (new)

**Purpose:** Client wrapper for filter state.

```tsx
'use client'

import { useFilters } from '@/lib/hooks/use-filters'
import { ScatterPlot } from '@/components/visualization/scatter-plot'
import { CategoryFilter } from '@/components/filters/category-filter'
import { CategoryChart } from '@/components/visualization/category-chart'
import { CountDisplay } from '@/components/obituary/count-display'
import type { ObituarySummary } from '@/types/obituary'

interface HomePageClientProps {
  obituaries: ObituarySummary[]
}

export function HomePageClient({ obituaries }: HomePageClientProps) {
  const {
    categories,
    toggleCategory,
    clearFilters,
    hasActiveFilters,
  } = useFilters()

  // Count only filtered obituaries for display
  const filteredCount = useMemo(() => {
    if (!hasActiveFilters) return obituaries.length
    return obituaries.filter(ob =>
      ob.categories.some(cat => categories.includes(cat))
    ).length
  }, [obituaries, categories, hasActiveFilters])

  return (
    <div className="min-h-screen">
      {/* Hero Section */}
      <section className="relative">
        <CountDisplay
          count={filteredCount}
          isFiltered={hasActiveFilters}
        />
      </section>

      {/* Timeline Section */}
      <section className="relative pb-24">
        <ScatterPlot
          data={obituaries}
          activeCategories={categories}
        />

        {/* Floating Filter Bar */}
        <CategoryFilter
          activeCategories={categories}
          onToggle={toggleCategory}
          onShowAll={clearFilters}
        />
      </section>

      {/* Category Breakdown */}
      <section className="max-w-md mx-auto px-4 py-8">
        <h2 className="text-lg font-semibold mb-4 text-[--text-primary]">
          Category Breakdown
        </h2>
        <CategoryChart
          obituaries={obituaries}
          activeCategories={categories}
          onCategoryClick={toggleCategory}
        />
      </section>
    </div>
  )
}
```

---

## 6. Stories with Acceptance Criteria

### Story 4.1: Category Data Model

**As a** developer,
**I want** categories consistently defined across the app,
**So that** colors and labels are uniform everywhere.

**Acceptance Criteria:**

| # | Given | When | Then |
|---|-------|------|------|
| AC-4.1.1 | The application runs | Categories are referenced anywhere | Four categories exist: capability, market, agi, dismissive |
| AC-4.1.2 | Category definitions are loaded | I check properties | Each has id, label, description, color, colorVar |
| AC-4.1.3 | I call getCategoryColor('market') | Function executes | Returns '#7B9E89' |
| AC-4.1.4 | I call getCategoryLabel('agi') | Function executes | Returns 'AGI Skepticism' |
| AC-4.1.5 | I call isValidCategory('market') | Function executes | Returns true |
| AC-4.1.6 | I call isValidCategory('invalid') | Function executes | Returns false |

**Technical Notes:**
- Create `src/lib/constants/categories.ts`
- Colors must match CSS variables in globals.css
- Export as const for type inference

**Files to Create:**
- `src/lib/constants/categories.ts`

---

### Story 4.2: Category Filter Bar

**As a** visitor,
**I want** to filter obituaries by category,
**So that** I can focus on specific types of skepticism.

**Acceptance Criteria:**

| # | Given | When | Then |
|---|-------|------|------|
| AC-4.2.1 | Homepage is loaded | Filter bar is visible | It displays "All" button and one pill per category (4 pills) |
| AC-4.2.2 | Filter bar is visible | I view position | It's at bottom center, floating, with backdrop blur |
| AC-4.2.3 | No filters active | I view "All" button | It appears selected (highlighted) |
| AC-4.2.4 | I click a category pill | Pill state changes | It becomes active (highlighted with category color background) |
| AC-4.2.5 | Multiple categories selected | I view pills | Multiple pills can be active simultaneously |
| AC-4.2.6 | Categories are selected | I click "All" | All category filters are cleared |
| AC-4.2.7 | On mobile viewport | I view filter bar | Pills are horizontally scrollable if they overflow |
| AC-4.2.8 | I hover a pill | Visual feedback | Pill shows hover state (bg change) |

**Technical Notes:**
- Create `src/components/filters/category-filter.tsx`
- Create `src/components/filters/category-pill.tsx`
- Use shadcn/ui or custom buttons
- Minimum touch target: 44px height

**Files to Create:**
- `src/components/filters/category-filter.tsx`
- `src/components/filters/category-pill.tsx`

---

### Story 4.3: URL State with nuqs

**As a** visitor,
**I want** filter state saved in the URL,
**So that** I can share filtered views and bookmark them.

**Acceptance Criteria:**

| # | Given | When | Then |
|---|-------|------|------|
| AC-4.3.1 | I select "market" category | URL is checked | URL shows `?cat=market` |
| AC-4.3.2 | I select "market" and "agi" | URL is checked | URL shows `?cat=market,agi` (order may vary) |
| AC-4.3.3 | I click "All" (clear filters) | URL is checked | `cat` param is removed from URL |
| AC-4.3.4 | I visit `/?cat=market` | Page loads | Market category is pre-selected in filter bar |
| AC-4.3.5 | I visit `/?cat=market,agi` | Page loads | Both market and agi are pre-selected |
| AC-4.3.6 | I share URL with filters | Recipient opens link | They see same filtered state |
| AC-4.3.7 | Filters change rapidly | URL updates | No page reload (shallow updates), debounced if needed |
| AC-4.3.8 | Invalid category in URL (`?cat=invalid`) | Page loads | Invalid value ignored, valid categories applied |

**Technical Notes:**
- Install and configure nuqs 2.x
- Create `src/lib/hooks/use-filters.ts`
- Add NuqsAdapter to layout.tsx

**Files to Create:**
- `src/lib/hooks/use-filters.ts`

**Files to Modify:**
- `src/app/layout.tsx` (add NuqsAdapter)

---

### Story 4.4: Filter Effect on Timeline

**As a** visitor,
**I want** the timeline to update when I filter,
**So that** I can see the pattern for specific categories.

**Acceptance Criteria:**

| # | Given | When | Then |
|---|-------|------|------|
| AC-4.4.1 | I select "market" category | Timeline updates | Non-market dots fade to 20% opacity |
| AC-4.4.2 | I select "market" category | Timeline updates | Market dots remain at full opacity (80%) with glow |
| AC-4.4.3 | Non-matching dots are faded | I hover a faded dot | Nothing happens (non-interactive) |
| AC-4.4.4 | Non-matching dots are faded | I click a faded dot | Nothing happens (non-interactive) |
| AC-4.4.5 | Matching dots are visible | I hover a dot | Normal hover behavior (tooltip, scale) |
| AC-4.4.6 | Filter changes | Transition occurs | 200ms ease-in-out opacity transition |
| AC-4.4.7 | I clear filters ("All") | Timeline updates | All dots return to normal state |
| AC-4.4.8 | Faded dots visible | Spatial context | Faded dots remain in position (layout unchanged) |

**Technical Notes:**
- Modify ScatterPlot to accept activeCategories prop
- Modify ScatterPoint to handle isFiltered state
- Use CSS transition for smooth opacity change

**Files to Modify:**
- `src/components/visualization/scatter-plot.tsx`
- `src/components/visualization/scatter-point.tsx`

---

### Story 4.5: Category Breakdown Chart

**As a** visitor,
**I want** to see the distribution of obituaries by category,
**So that** I understand what types of skepticism are most common.

**Acceptance Criteria:**

| # | Given | When | Then |
|---|-------|------|------|
| AC-4.5.1 | Homepage is loaded | Chart is visible | Horizontal bar chart shows all 4 categories |
| AC-4.5.2 | Chart renders | I view bars | Each bar uses its category color |
| AC-4.5.3 | Chart renders | I view labels | Count and percentage shown for each (e.g., "48 (31%)") |
| AC-4.5.4 | Chart renders | I view order | Bars sorted by count (highest first) |
| AC-4.5.5 | Filters are active | I view chart | Non-filtered categories appear dimmed (40% opacity) |
| AC-4.5.6 | I click a bar | Filter state | That category is toggled in filter |
| AC-4.5.7 | I hover a bar | Visual feedback | Bar shows hover state |
| AC-4.5.8 | Page loads | Animation | Bars animate in (grow from 0) |

**Technical Notes:**
- Create `src/components/visualization/category-chart.tsx`
- Can use CSS bars or Visx for more complex charts
- Compact design fits in sidebar or below timeline

**Files to Create:**
- `src/components/visualization/category-chart.tsx`

---

## 7. API and Data Fetching

### 7.1 No New Queries Required

Epic 4 uses existing data from Epic 2. Filtering is performed client-side.

**Existing Query (from Epic 2):**
```typescript
// src/lib/sanity/queries.ts
export async function getObituaries(): Promise<ObituarySummary[]>
// Already includes categories[] in response
```

### 7.2 Client-Side Filtering Strategy

**Rationale:** Filter client-side rather than server-side because:
1. Dataset is small (< 500 obituaries expected)
2. Enables instant filter response (no network latency)
3. Simplifies caching (all data cached, filters applied locally)
4. Maintains spatial context (faded dots remain visible)

**If scale becomes an issue (> 1000 obituaries):**
- Consider server-side filtering via searchParams
- Implement with Sanity GROQ: `*[_type == "obituary" && category in $categories]`
- Would require page reload or client fetch on filter change

---

## 8. Testing Strategy

### 8.1 Unit Tests

**File:** `tests/unit/lib/constants/categories.test.ts`

```typescript
import { describe, it, expect } from 'vitest'
import {
  CATEGORIES,
  CATEGORY_ORDER,
  getCategoryColor,
  getCategoryLabel,
  isValidCategory,
  getAllCategories,
} from '@/lib/constants/categories'

describe('CATEGORIES', () => {
  it('contains all four categories', () => {
    expect(Object.keys(CATEGORIES)).toHaveLength(4)
    expect(CATEGORIES.capability).toBeDefined()
    expect(CATEGORIES.market).toBeDefined()
    expect(CATEGORIES.agi).toBeDefined()
    expect(CATEGORIES.dismissive).toBeDefined()
  })

  it('each category has required properties', () => {
    Object.values(CATEGORIES).forEach(cat => {
      expect(cat.id).toBeDefined()
      expect(cat.label).toBeDefined()
      expect(cat.color).toMatch(/^#[0-9A-Fa-f]{6}$/)
      expect(cat.colorVar).toMatch(/^--category-/)
    })
  })
})

describe('getCategoryColor', () => {
  it('returns correct colors', () => {
    expect(getCategoryColor('capability')).toBe('#C9A962')
    expect(getCategoryColor('market')).toBe('#7B9E89')
    expect(getCategoryColor('agi')).toBe('#9E7B7B')
    expect(getCategoryColor('dismissive')).toBe('#7B7B9E')
  })
})

describe('getCategoryLabel', () => {
  it('returns correct labels', () => {
    expect(getCategoryLabel('capability')).toBe('Capability Doubt')
    expect(getCategoryLabel('market')).toBe('Market/Bubble')
    expect(getCategoryLabel('agi')).toBe('AGI Skepticism')
    expect(getCategoryLabel('dismissive')).toBe('Dismissive Framing')
  })
})

describe('isValidCategory', () => {
  it('returns true for valid categories', () => {
    expect(isValidCategory('market')).toBe(true)
    expect(isValidCategory('capability')).toBe(true)
  })

  it('returns false for invalid values', () => {
    expect(isValidCategory('invalid')).toBe(false)
    expect(isValidCategory('')).toBe(false)
  })
})
```

**File:** `tests/unit/lib/hooks/use-filters.test.ts`

```typescript
import { renderHook, act } from '@testing-library/react'
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { useFilters } from '@/lib/hooks/use-filters'
import { NuqsTestingAdapter } from 'nuqs/adapters/testing'

// Wrapper for nuqs testing
const wrapper = ({ children }: { children: React.ReactNode }) => (
  <NuqsTestingAdapter>{children}</NuqsTestingAdapter>
)

describe('useFilters', () => {
  it('returns empty categories by default', () => {
    const { result } = renderHook(() => useFilters(), { wrapper })
    expect(result.current.categories).toEqual([])
    expect(result.current.hasActiveFilters).toBe(false)
  })

  it('toggleCategory adds category', async () => {
    const { result } = renderHook(() => useFilters(), { wrapper })

    act(() => {
      result.current.toggleCategory('market')
    })

    expect(result.current.categories).toContain('market')
    expect(result.current.hasActiveFilters).toBe(true)
  })

  it('toggleCategory removes existing category', async () => {
    const { result } = renderHook(() => useFilters(), { wrapper })

    act(() => {
      result.current.toggleCategory('market')
    })
    act(() => {
      result.current.toggleCategory('market')
    })

    expect(result.current.categories).not.toContain('market')
  })

  it('clearFilters removes all categories', async () => {
    const { result } = renderHook(() => useFilters(), { wrapper })

    act(() => {
      result.current.setCategories(['market', 'agi'])
    })
    act(() => {
      result.current.clearFilters()
    })

    expect(result.current.categories).toEqual([])
  })

  it('isCategoryActive returns true when no filters', () => {
    const { result } = renderHook(() => useFilters(), { wrapper })
    expect(result.current.isCategoryActive('market')).toBe(true)
  })

  it('isCategoryActive returns correctly when filtered', () => {
    const { result } = renderHook(() => useFilters(), { wrapper })

    act(() => {
      result.current.setCategories(['market'])
    })

    expect(result.current.isCategoryActive('market')).toBe(true)
    expect(result.current.isCategoryActive('agi')).toBe(false)
  })
})
```

### 8.2 Component Tests

**File:** `tests/unit/components/filters/category-filter.test.tsx`

```typescript
import { render, screen, fireEvent } from '@testing-library/react'
import { describe, it, expect, vi } from 'vitest'
import { CategoryFilter } from '@/components/filters/category-filter'

describe('CategoryFilter', () => {
  const defaultProps = {
    activeCategories: [],
    onToggle: vi.fn(),
    onShowAll: vi.fn(),
  }

  it('renders all category pills', () => {
    render(<CategoryFilter {...defaultProps} />)

    expect(screen.getByTestId('category-pill-capability')).toBeInTheDocument()
    expect(screen.getByTestId('category-pill-market')).toBeInTheDocument()
    expect(screen.getByTestId('category-pill-agi')).toBeInTheDocument()
    expect(screen.getByTestId('category-pill-dismissive')).toBeInTheDocument()
  })

  it('renders All button', () => {
    render(<CategoryFilter {...defaultProps} />)
    expect(screen.getByTestId('filter-all-button')).toBeInTheDocument()
  })

  it('calls onToggle when pill clicked', () => {
    const onToggle = vi.fn()
    render(<CategoryFilter {...defaultProps} onToggle={onToggle} />)

    fireEvent.click(screen.getByTestId('category-pill-market'))
    expect(onToggle).toHaveBeenCalledWith('market')
  })

  it('calls onShowAll when All button clicked', () => {
    const onShowAll = vi.fn()
    render(<CategoryFilter {...defaultProps} onShowAll={onShowAll} />)

    fireEvent.click(screen.getByTestId('filter-all-button'))
    expect(onShowAll).toHaveBeenCalled()
  })

  it('shows active state for selected categories', () => {
    render(
      <CategoryFilter
        {...defaultProps}
        activeCategories={['market']}
      />
    )

    const marketPill = screen.getByTestId('category-pill-market')
    // Check for active styling (implementation dependent)
    expect(marketPill).toHaveStyle({ backgroundColor: expect.stringContaining('#7B9E89') })
  })
})
```

**File:** `tests/unit/components/visualization/category-chart.test.tsx`

```typescript
import { render, screen, fireEvent } from '@testing-library/react'
import { describe, it, expect, vi } from 'vitest'
import { CategoryChart } from '@/components/visualization/category-chart'

describe('CategoryChart', () => {
  const mockObituaries = [
    { categories: ['market'] },
    { categories: ['market'] },
    { categories: ['capability'] },
    { categories: ['agi'] },
    { categories: ['dismissive'] },
  ]

  it('renders all category bars', () => {
    render(<CategoryChart obituaries={mockObituaries} />)

    expect(screen.getByTestId('category-bar-capability')).toBeInTheDocument()
    expect(screen.getByTestId('category-bar-market')).toBeInTheDocument()
    expect(screen.getByTestId('category-bar-agi')).toBeInTheDocument()
    expect(screen.getByTestId('category-bar-dismissive')).toBeInTheDocument()
  })

  it('shows correct counts', () => {
    render(<CategoryChart obituaries={mockObituaries} />)

    // Market has 2 obituaries (40%)
    expect(screen.getByText(/2 \(40%\)/)).toBeInTheDocument()
  })

  it('calls onCategoryClick when bar clicked', () => {
    const onClick = vi.fn()
    render(
      <CategoryChart
        obituaries={mockObituaries}
        onCategoryClick={onClick}
      />
    )

    fireEvent.click(screen.getByTestId('category-bar-market'))
    expect(onClick).toHaveBeenCalledWith('market')
  })

  it('dims non-active categories when filtered', () => {
    render(
      <CategoryChart
        obituaries={mockObituaries}
        activeCategories={['market']}
      />
    )

    const marketBar = screen.getByTestId('category-bar-market')
    const agiBar = screen.getByTestId('category-bar-agi')

    // Implementation dependent - check opacity class or style
    expect(marketBar).toHaveClass('opacity-100')
    expect(agiBar).toHaveClass('opacity-40')
  })
})
```

### 8.3 E2E Tests

**File:** `tests/e2e/filtering.spec.ts`

```typescript
import { test, expect } from '@playwright/test'

test.describe('Category Filtering', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/')
  })

  test('filter bar is visible', async ({ page }) => {
    const filterBar = page.locator('[data-testid="category-filter"]')
    await expect(filterBar).toBeVisible()
  })

  test('clicking category updates URL', async ({ page }) => {
    await page.click('[data-testid="category-pill-market"]')
    await expect(page).toHaveURL(/cat=market/)
  })

  test('clicking multiple categories updates URL', async ({ page }) => {
    await page.click('[data-testid="category-pill-market"]')
    await page.click('[data-testid="category-pill-agi"]')

    // URL should contain both (order may vary)
    const url = page.url()
    expect(url).toMatch(/cat=/)
    expect(url).toContain('market')
    expect(url).toContain('agi')
  })

  test('clicking All clears filters', async ({ page }) => {
    await page.click('[data-testid="category-pill-market"]')
    await expect(page).toHaveURL(/cat=market/)

    await page.click('[data-testid="filter-all-button"]')
    await expect(page).not.toHaveURL(/cat=/)
  })

  test('URL with filter pre-selects category', async ({ page }) => {
    await page.goto('/?cat=market')

    const marketPill = page.locator('[data-testid="category-pill-market"]')
    // Check for active state (implementation dependent)
    await expect(marketPill).toHaveAttribute('aria-pressed', 'true')
  })

  test('filtered timeline fades non-matching dots', async ({ page }) => {
    await page.click('[data-testid="category-pill-market"]')

    // Wait for transition
    await page.waitForTimeout(300)

    // Non-market dots should have reduced opacity
    const nonMarketDot = page.locator('[data-testid="scatter-point"][data-category="capability"]').first()
    if (await nonMarketDot.isVisible()) {
      await expect(nonMarketDot).toHaveCSS('opacity', '0.2')
    }
  })

  test('shared URL preserves filter state', async ({ page, context }) => {
    await page.click('[data-testid="category-pill-market"]')
    const url = page.url()

    // Open new page with same URL
    const newPage = await context.newPage()
    await newPage.goto(url)

    // Filter should be active
    const marketPill = newPage.locator('[data-testid="category-pill-market"]')
    await expect(marketPill).toHaveAttribute('aria-pressed', 'true')
  })

  test('category chart is visible and interactive', async ({ page }) => {
    const chart = page.locator('[data-testid="category-chart"]')
    await expect(chart).toBeVisible()

    // Click a bar to filter
    await page.click('[data-testid="category-bar-market"]')
    await expect(page).toHaveURL(/cat=market/)
  })
})
```

---

## 9. Non-Functional Requirements

### 9.1 Performance Requirements

| Metric | Target | How to Measure |
|--------|--------|----------------|
| Filter toggle response | < 100ms | DevTools Performance |
| URL update (nuqs) | No page reload | Network tab |
| Timeline fade transition | 200ms, 60fps | DevTools FPS meter |
| Initial category count | < 10ms | useMemo performance |

### 9.2 Accessibility Requirements

| Requirement | Implementation |
|-------------|----------------|
| Keyboard navigation | Tab through pills, Enter/Space to toggle |
| Screen reader | aria-pressed state on pills, aria-label on chart bars |
| Touch targets | Minimum 44px height on all interactive elements |
| Focus indicators | Visible focus ring on pills and bars |
| Color independence | Labels accompany color indicators |

### 9.3 URL State Requirements

| Requirement | Implementation |
|-------------|----------------|
| Shallow routing | No page reload on filter change |
| History management | Replace state (no history spam) |
| Invalid params | Gracefully ignore invalid category values |
| Empty state | No cat param when showing all |
| Case sensitivity | Lowercase only (market, not Market) |

---

## 10. Traceability Matrix

### 10.1 FR to Story Mapping

| FR | Story | Components | Tests |
|----|-------|------------|-------|
| FR14 | 4.1 | categories.ts | categories.test.ts |
| FR15 | 4.2, 4.4 | CategoryFilter, ScatterPlot | category-filter.test.tsx, filtering.spec.ts |
| FR16 | 4.5 | CategoryChart | category-chart.test.tsx, filtering.spec.ts |
| FR17 | 4.4 | ScatterPoint | filtering.spec.ts |
| FR18 | 4.3 | useFilters | use-filters.test.ts, filtering.spec.ts |

### 10.2 Acceptance Criteria Count

| Story | AC Count |
|-------|----------|
| 4.1 | 6 |
| 4.2 | 8 |
| 4.3 | 8 |
| 4.4 | 8 |
| 4.5 | 8 |
| **Total** | **38** |

---

## 11. Implementation Order

**Recommended Story Sequence:**

1. **Story 4.1: Category Data Model** - Foundation for all other stories
2. **Story 4.3: URL State with nuqs** - Core infrastructure for filter state
3. **Story 4.2: Category Filter Bar** - UI component using filter state
4. **Story 4.4: Filter Effect on Timeline** - Visual filtering integration
5. **Story 4.5: Category Breakdown Chart** - Distribution visualization

**Rationale:**
- 4.1 must come first (defines categories)
- 4.3 before 4.2 (filter bar needs useFilters hook)
- 4.4 depends on filter state being available
- 4.5 can be done last (independent visualization)

---

## 12. Risks and Mitigations

### 12.1 Technical Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| nuqs SSR compatibility | High | Low | Use NuqsAdapter, test server rendering |
| URL param conflicts | Medium | Low | Use unique param name ('cat') |
| Filter state sync issues | Medium | Medium | Centralize state in useFilters hook |
| Performance with many dots | Low | Low | Already handled in Epic 3 |

### 12.2 UX Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| Filter bar obscures content | Medium | Position above content, add padding |
| Users don't notice filter bar | Medium | Animation on page load, prominent position |
| Faded dots confusing | Low | Keep in position for spatial context |

---

## 13. Open Questions

1. **Filter Persistence:** Should filter state persist across sessions (localStorage) or only in URL?
   - **Recommendation:** URL only. This ensures shareability and predictability.

2. **Mobile Filter Bar:** Should filter bar be different on mobile?
   - **Answer:** Horizontally scrollable on mobile (same component).

3. **Multi-Category Obituaries:** How to handle obituaries with multiple categories?
   - **Answer:** Show if ANY category matches filter (OR logic, not AND).

4. **Count Display:** Should count update when filtering?
   - **Recommendation:** Yes, show filtered count with indication it's filtered.

---

## 14. Summary

Epic 4 implements the category system and filtering functionality that enables focused exploration and shareable views. The implementation uses nuqs for URL-synced state, ensuring that filtered views can be bookmarked and shared.

**Key Deliverables:**
- Category constants with consistent colors and labels
- Floating filter bar with toggle pills
- URL-persisted filter state via nuqs
- Timeline filtering with faded non-matching dots
- Category breakdown chart with click-to-filter

**Success Criteria:**
- All 5 FRs (FR14-FR18) implemented
- URL reflects filter state
- Shared URLs preserve filters
- Filter toggle response < 100ms
- All E2E tests passing

---

_Generated by Epic Tech Context Specialist_
_Date: 2025-11-30_
_For: Luca_

---

**Document incorporates context from:**
- [PRD](../../prd.md) - Functional Requirements FR14-FR18
- [Architecture](../../architecture.md) - nuqs, URL State Pattern, Category Colors
- [Epics](../../epics.md) - Epic 4 stories and acceptance criteria
