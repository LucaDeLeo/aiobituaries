# Epic 5: Navigation & Responsive Experience - Technical Specification

**Epic ID:** 5
**Epic Title:** Navigation & Responsive Experience
**Date:** 2025-11-30
**Author:** Generated by Epic Tech Context Specialist

---

## 1. Epic Overview

### 1.1 Description

Epic 5 completes the navigation flow and ensures the site works beautifully across all device sizes. This epic bridges the gap between the modal preview (Epic 3) and full obituary pages (Epic 2), adds previous/next navigation for sequential browsing, implements position preservation so users never lose their place, and creates the mobile-first hybrid experience that adapts the timeline visualization for touch devices.

The core innovation is the "Mobile Hybrid View" - a density bar + vertical card list that maintains the visual pattern story while being fully usable on small screens. Desktop and tablet users get the full horizontal timeline experience, while mobile users get an optimized touch-friendly alternative.

### 1.2 Business Value and Goals

- **Seamless Exploration:** Users can drill from timeline dots into full pages and back without friction
- **Sequential Discovery:** Previous/next navigation encourages deeper exploration ("one more obituary")
- **Position Memory:** Returning to timeline preserves scroll/zoom state - no re-orientation needed
- **Universal Access:** Site works on all devices from 320px phones to 4K desktops
- **Touch Optimization:** Mobile experience is native-feeling, not a cramped desktop port
- **Location Awareness:** Breadcrumbs provide orientation on deep pages

### 1.3 Functional Requirements Covered

| FR ID | Requirement | Story |
|-------|-------------|-------|
| FR13 | Timeline gracefully degrades to list view on mobile devices | 5.5 |
| FR20 | Users can navigate from modal view to full obituary page | 5.1 |
| FR21 | Users can navigate between obituaries (previous/next) | 5.2 |
| FR22 | Users can return to timeline with scroll position preserved | 5.3 |
| FR26 | System provides breadcrumb navigation on detail pages | 5.4 |
| FR34 | Site is fully functional on mobile devices (320px+) | 5.5 |
| FR35 | Site is fully functional on tablet devices (768px+) | 5.6 |
| FR36 | Site provides optimal experience on desktop (1024px+) | 5.6 |
| FR37 | Timeline visualization adapts appropriately per breakpoint | 5.5, 5.6 |

### 1.4 Scope

**In-Scope (6 Stories):**
- Story 5.1: Modal to Full Page Transition (View full page button)
- Story 5.2: Previous/Next Navigation (sequential browsing)
- Story 5.3: Position Preservation (scroll/zoom state memory)
- Story 5.4: Breadcrumb Navigation (location awareness)
- Story 5.5: Mobile Hybrid View (density bar + card list)
- Story 5.6: Tablet & Desktop Polish (responsive refinements)

**Out-of-Scope:**
- Touch gestures beyond basic swipe (complex multi-finger gestures)
- Offline support / PWA features (Growth feature)
- Deep linking to specific timeline positions (URL only includes filters)
- View Transitions API (optional enhancement, not required)
- Animated page transitions between routes

### 1.5 Dependencies and Prerequisites

**Epic Dependencies:**
- Epic 1 complete (Foundation)
  - Layout shell with header/footer
  - Sanity CMS with obituary data
  - Mobile nav via Sheet component
- Epic 2 complete (Core Content Display)
  - Individual obituary pages at /obituary/[slug]
  - ObituaryCard component
  - ObituaryDetail component
- Epic 3 complete (Timeline Visualization)
  - ScatterPlot with scroll/zoom
  - ObituaryModal with sheet implementation
  - Click handler opening modal
- Epic 4 complete (Category System & Filtering)
  - CategoryFilter bar component
  - URL state with nuqs
  - Filter effect on timeline dots

**External Dependencies:**
- nuqs 2.x (already installed for Epic 4)
- shadcn/ui Sheet component (already used)
- shadcn/ui Breadcrumb component (to be added)
- sessionStorage API (browser built-in)
- CSS Container Queries (modern browsers)

---

## 2. Technical Context

### 2.1 Relevant Architecture Decisions

| ADR | Decision | Impact on Epic 5 |
|-----|----------|------------------|
| ADR-004 | URL State with nuqs | Filter state preserved in URL, but scroll/zoom in sessionStorage |
| - | Server Components | Detail pages server-rendered, navigation computed server-side |
| - | Mobile Strategy | Hybrid view, not cramped desktop - different component tree |
| - | Position Storage | sessionStorage for ephemeral state (not URL) |

### 2.2 Technology Stack for Epic 5

| Technology | Version | Purpose in Epic 5 |
|------------|---------|-------------------|
| nuqs | 2.x | Filter state preserved across navigation |
| shadcn/ui | 3.5.0 | Breadcrumb, Sheet (bottom for mobile) |
| sessionStorage | Browser API | Timeline position memory |
| Tailwind CSS | 4.1.x | Responsive breakpoints, container queries |
| Next.js | 16.x | Link component, usePathname, searchParams |

### 2.3 Project Structure (Epic 5 Additions)

```
src/
├── app/
│   ├── page.tsx                      # Modify: Responsive layout switching
│   └── obituary/
│       └── [slug]/
│           └── page.tsx              # Modify: Add prev/next, breadcrumbs
│
├── components/
│   ├── layout/
│   │   └── header.tsx                # Modify: Mobile count display
│   │
│   ├── mobile/
│   │   ├── mobile-timeline.tsx       # Create: Mobile view container
│   │   ├── density-bar.tsx           # Create: Visual density indicator
│   │   └── mobile-card-list.tsx      # Create: Vertical scrolling list
│   │
│   ├── obituary/
│   │   ├── obituary-modal.tsx        # Modify: Add "View full page" button
│   │   ├── obituary-nav.tsx          # Create: Previous/next navigation
│   │   └── obituary-detail.tsx       # Modify: Accept prev/next props
│   │
│   ├── ui/
│   │   ├── breadcrumb.tsx            # Create/Add: shadcn breadcrumb
│   │   └── responsive-container.tsx  # Create: Breakpoint wrapper
│   │
│   └── visualization/
│       └── scatter-plot.tsx          # Modify: Position save/restore
│
├── lib/
│   └── hooks/
│       ├── use-timeline-position.ts  # Create: sessionStorage hook
│       ├── use-breakpoint.ts         # Create: Responsive detection
│       └── use-filters.ts            # Already exists (Epic 4)
│
└── types/
    └── navigation.ts                 # Create: Navigation types
```

### 2.4 Integration Points

```
Epic 5 Navigation Flow:

┌─────────────────────────────────────────────────────────────────┐
│                        Homepage (/)                               │
│                                                                   │
│  Desktop/Tablet:                    Mobile:                       │
│  ┌─────────────────────┐           ┌─────────────────────┐       │
│  │   ScatterPlot       │           │   DensityBar        │       │
│  │   (full timeline)   │           │   + CardList        │       │
│  └──────────┬──────────┘           └──────────┬──────────┘       │
│             │                                  │                   │
│             │ Click dot                        │ Tap card          │
│             ▼                                  ▼                   │
│  ┌─────────────────────┐           ┌─────────────────────┐       │
│  │  ObituaryModal      │           │  ObituaryModal      │       │
│  │  (Sheet right)      │           │  (Sheet bottom)     │       │
│  │                     │           │                     │       │
│  │  [View full page]   │           │  [View full page]   │       │
│  └──────────┬──────────┘           └──────────┬──────────┘       │
│             │                                  │                   │
└─────────────┼──────────────────────────────────┼───────────────────┘
              │                                  │
              └──────────────┬───────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                   /obituary/[slug]                                │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  Breadcrumb: Home > Obituary                                 │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    ObituaryDetail                            │ │
│  │                                                               │ │
│  │  Full claim, source, date, context...                        │ │
│  │                                                               │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │  ObituaryNav                                                  │ │
│  │  [<- Previous: "AI is dead..."]  [Next: "The bubble..." ->]  │ │
│  └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│  ← Back to Timeline (position preserved)                         │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘

Position Preservation Flow:

┌─────────────┐     Save on scroll/zoom     ┌────────────────────┐
│ ScatterPlot │ ────────────────────────────► │  sessionStorage   │
│             │                               │                    │
│  scrollX    │     Key: timeline-position   │  { scrollX: 450,  │
│  zoomLevel  │                               │    zoom: 1.2,     │
│             │                               │    timestamp: ... }│
└─────────────┘                               └────────────────────┘
                                                       │
       Navigate to /obituary/[slug]                    │
                   │                                   │
                   ▼                                   │
┌─────────────────────────────────────────────────────────────────┐
│                   Obituary Detail Page                            │
│                                                                   │
│   Click "Back to Timeline" or browser back                       │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
                   │
                   ▼
┌─────────────┐     Restore on mount      ┌────────────────────┐
│ ScatterPlot │ ◄──────────────────────────│  sessionStorage   │
│             │                            │                    │
│  Scrolls to │                            │  Read position    │
│  saved pos  │                            │                    │
└─────────────┘                            └────────────────────┘
```

---

## 3. Data Models

### 3.1 Navigation Types

```typescript
// src/types/navigation.ts

/**
 * Adjacent obituary reference for prev/next navigation.
 */
export interface AdjacentObituary {
  /** Obituary slug */
  slug: string
  /** Claim text (truncated for display) */
  claimPreview: string
  /** Source name */
  source: string
  /** Publication date */
  date: string
}

/**
 * Navigation context for obituary detail pages.
 */
export interface ObituaryNavigation {
  /** Previous obituary (older by date) */
  previous: AdjacentObituary | null
  /** Next obituary (newer by date) */
  next: AdjacentObituary | null
}

/**
 * Timeline position state for sessionStorage.
 */
export interface TimelinePosition {
  /** Horizontal scroll position in pixels */
  scrollX: number
  /** Zoom level (0.5 to 5.0) */
  zoom: number
  /** Timestamp when saved (for expiry logic) */
  timestamp: number
}

/**
 * Breakpoint enum for responsive logic.
 */
export type Breakpoint = 'mobile' | 'tablet' | 'desktop'

/**
 * Breakpoint pixel boundaries.
 */
export const BREAKPOINTS = {
  mobile: { max: 767 },
  tablet: { min: 768, max: 1023 },
  desktop: { min: 1024 }
} as const
```

### 3.2 Extended Sanity Query for Navigation

```groq
// Query to get obituary with adjacent entries
// src/lib/sanity/queries.ts

export const obituaryWithNavQuery = groq`
*[_type == "obituary" && slug.current == $slug][0] {
  _id,
  "slug": slug.current,
  claim,
  source,
  sourceUrl,
  date,
  categories,
  context,

  // Previous obituary (older)
  "previous": *[_type == "obituary" && date < ^.date] | order(date desc) [0] {
    "slug": slug.current,
    "claimPreview": claim[0...100],
    source,
    date
  },

  // Next obituary (newer)
  "next": *[_type == "obituary" && date > ^.date] | order(date asc) [0] {
    "slug": slug.current,
    "claimPreview": claim[0...100],
    source,
    date
  }
}
`
```

### 3.3 SessionStorage Schema

```typescript
// sessionStorage key: 'timeline-position'
// Value: JSON.stringify(TimelinePosition)

interface StoredPosition {
  scrollX: number      // 0 to Infinity
  zoom: number         // 0.5 to 5.0
  timestamp: number    // Date.now()
}

// Example stored value:
// {"scrollX":450,"zoom":1.2,"timestamp":1732982400000}

// Expiry: Position expires after 1 hour of inactivity
const POSITION_EXPIRY_MS = 60 * 60 * 1000 // 1 hour
```

---

## 4. Component Specifications

### 4.1 Story 5.1: Modal to Full Page Transition

#### Component: ObituaryModal (Modification)

**File:** `src/components/obituary/obituary-modal.tsx`

**Changes:**
- Add "View full page" button at bottom of modal content
- Button triggers Link navigation to `/obituary/[slug]`
- Modal closes automatically via Next.js navigation

**Props Interface:**
```typescript
interface ObituaryModalProps {
  obituary: Obituary
  isOpen: boolean
  onClose: () => void
  // Existing props from Epic 3
}
```

**Implementation Details:**

```typescript
// Inside modal content, after existing content:
<div className="mt-6 flex justify-between items-center border-t border-[--border] pt-4">
  <CopyButton url={`${siteUrl}/obituary/${obituary.slug}`} />

  <Link
    href={`/obituary/${obituary.slug}`}
    className="inline-flex items-center gap-2 px-4 py-2 bg-[--accent-primary] text-[--bg-primary] rounded-lg font-medium hover:opacity-90 transition-opacity"
  >
    View full page
    <ArrowRightIcon className="w-4 h-4" />
  </Link>
</div>
```

**Acceptance Criteria:**
1. "View full page" button visible at bottom of modal
2. Button styled with gold background (primary action)
3. Clicking navigates to `/obituary/[slug]`
4. Modal closes during navigation
5. Focus management: focus moves to main content on new page

### 4.2 Story 5.2: Previous/Next Navigation

#### Component: ObituaryNav

**File:** `src/components/obituary/obituary-nav.tsx`

**Props Interface:**
```typescript
interface ObituaryNavProps {
  previous: AdjacentObituary | null
  next: AdjacentObituary | null
}
```

**Implementation:**

```typescript
'use client'

import Link from 'next/link'
import { useEffect } from 'react'
import { ChevronLeftIcon, ChevronRightIcon } from 'lucide-react'
import type { AdjacentObituary } from '@/types/navigation'

interface ObituaryNavProps {
  previous: AdjacentObituary | null
  next: AdjacentObituary | null
}

export function ObituaryNav({ previous, next }: ObituaryNavProps) {
  // Keyboard navigation
  useEffect(() => {
    function handleKeyDown(e: KeyboardEvent) {
      // Only if no input is focused
      if (document.activeElement?.tagName === 'INPUT') return

      if (e.key === 'ArrowLeft' && previous) {
        window.location.href = `/obituary/${previous.slug}`
      } else if (e.key === 'ArrowRight' && next) {
        window.location.href = `/obituary/${next.slug}`
      }
    }

    window.addEventListener('keydown', handleKeyDown)
    return () => window.removeEventListener('keydown', handleKeyDown)
  }, [previous, next])

  return (
    <nav
      className="flex justify-between items-stretch gap-4 mt-8 pt-6 border-t border-[--border]"
      aria-label="Obituary navigation"
    >
      {/* Previous */}
      {previous ? (
        <Link
          href={`/obituary/${previous.slug}`}
          className="group flex-1 flex items-center gap-3 p-4 rounded-lg bg-[--bg-card] border border-[--border] hover:border-[--accent-primary] transition-colors"
        >
          <ChevronLeftIcon className="w-5 h-5 text-[--text-muted] group-hover:text-[--accent-primary]" />
          <div className="flex flex-col min-w-0">
            <span className="text-xs text-[--text-muted] uppercase tracking-wider">Previous</span>
            <span className="text-sm text-[--text-secondary] truncate">{previous.source}</span>
          </div>
        </Link>
      ) : (
        <div className="flex-1" />
      )}

      {/* Next */}
      {next ? (
        <Link
          href={`/obituary/${next.slug}`}
          className="group flex-1 flex items-center justify-end gap-3 p-4 rounded-lg bg-[--bg-card] border border-[--border] hover:border-[--accent-primary] transition-colors text-right"
        >
          <div className="flex flex-col min-w-0">
            <span className="text-xs text-[--text-muted] uppercase tracking-wider">Next</span>
            <span className="text-sm text-[--text-secondary] truncate">{next.source}</span>
          </div>
          <ChevronRightIcon className="w-5 h-5 text-[--text-muted] group-hover:text-[--accent-primary]" />
        </Link>
      ) : (
        <div className="flex-1" />
      )}
    </nav>
  )
}
```

**Visual Spec:**

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  ┌────────────────────────┐  ┌────────────────────────┐    │
│  │ <  Previous            │  │           Next  >      │    │
│  │     Gary Marcus        │  │     TechCrunch         │    │
│  └────────────────────────┘  └────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘

- Cards equal width (flex-1)
- Hover: gold border, icon color change
- Keyboard: Left/Right arrow keys navigate
```

**Acceptance Criteria:**
1. Previous links to older obituary (by date)
2. Next links to newer obituary (by date)
3. Missing direction shows empty space (maintains layout)
4. Keyboard arrows (Left/Right) trigger navigation
5. Shows source name as label
6. Hover state with gold accent

### 4.3 Story 5.3: Position Preservation

#### Hook: useTimelinePosition

**File:** `src/lib/hooks/use-timeline-position.ts`

```typescript
'use client'

import { useCallback, useEffect, useState } from 'react'
import type { TimelinePosition } from '@/types/navigation'

const STORAGE_KEY = 'timeline-position'
const EXPIRY_MS = 60 * 60 * 1000 // 1 hour

interface UseTimelinePositionReturn {
  /** Current position (null if not yet loaded) */
  position: TimelinePosition | null
  /** Save new position (debounced internally) */
  savePosition: (pos: Omit<TimelinePosition, 'timestamp'>) => void
  /** Clear stored position */
  clearPosition: () => void
  /** Whether position was restored from storage */
  wasRestored: boolean
}

export function useTimelinePosition(): UseTimelinePositionReturn {
  const [position, setPosition] = useState<TimelinePosition | null>(null)
  const [wasRestored, setWasRestored] = useState(false)

  // Load position on mount
  useEffect(() => {
    try {
      const stored = sessionStorage.getItem(STORAGE_KEY)
      if (stored) {
        const parsed: TimelinePosition = JSON.parse(stored)

        // Check expiry
        if (Date.now() - parsed.timestamp < EXPIRY_MS) {
          setPosition(parsed)
          setWasRestored(true)
        } else {
          sessionStorage.removeItem(STORAGE_KEY)
        }
      }
    } catch (e) {
      console.warn('Failed to load timeline position:', e)
    }
  }, [])

  // Save position with debounce
  const savePosition = useCallback((pos: Omit<TimelinePosition, 'timestamp'>) => {
    const newPosition: TimelinePosition = {
      ...pos,
      timestamp: Date.now()
    }

    setPosition(newPosition)

    try {
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(newPosition))
    } catch (e) {
      if (e instanceof Error && e.name === 'QuotaExceededError') {
        console.warn('sessionStorage quota exceeded, position not saved:', e)
      } else {
        console.warn('Failed to save timeline position:', e)
      }
    }
  }, [])

  const clearPosition = useCallback(() => {
    setPosition(null)
    setWasRestored(false)
    try {
      sessionStorage.removeItem(STORAGE_KEY)
    } catch (e) {
      // Ignore
    }
  }, [])

  return { position, savePosition, clearPosition, wasRestored }
}
```

#### Integration with ScatterPlot

**File:** `src/components/visualization/scatter-plot.tsx` (modification)

```typescript
// Add to ScatterPlot component:

import { useTimelinePosition } from '@/lib/hooks/use-timeline-position'

export function ScatterPlot({ data, activeCategories }: ScatterPlotProps) {
  const { position, savePosition, wasRestored } = useTimelinePosition()
  const [scrollX, setScrollX] = useState(0)
  const [zoom, setZoom] = useState(1)

  // Restore position on mount
  useEffect(() => {
    if (wasRestored && position) {
      setScrollX(position.scrollX)
      setZoom(position.zoom)
      // Scroll the container to position
      containerRef.current?.scrollTo({ left: position.scrollX })
    }
  }, [wasRestored, position])

  // Save position on scroll/zoom change (debounced)
  useEffect(() => {
    const timeout = setTimeout(() => {
      savePosition({ scrollX, zoom })
    }, 300) // Debounce 300ms

    return () => clearTimeout(timeout)
  }, [scrollX, zoom, savePosition])

  // ... rest of component
}
```

**Acceptance Criteria:**
1. Position saved to sessionStorage on scroll/zoom change
2. Position restored when returning to homepage
3. Position expires after 1 hour of inactivity
4. Browser back button preserves position
5. "Back to Timeline" link preserves position
6. Works with filter state (filters in URL, position in sessionStorage)

### 4.4 Story 5.4: Breadcrumb Navigation

#### Component: Breadcrumb

**File:** `src/components/ui/breadcrumb.tsx`

Use shadcn/ui Breadcrumb component:
```bash
npx shadcn@latest add breadcrumb
```

#### Integration in Obituary Page

**File:** `src/app/obituary/[slug]/page.tsx`

```typescript
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb'

export default async function ObituaryPage({ params }: Props) {
  const obituary = await getObituaryBySlug(params.slug)

  return (
    <main className="container max-w-4xl mx-auto px-4 py-8">
      {/* Breadcrumb */}
      <Breadcrumb className="mb-6">
        <BreadcrumbList>
          <BreadcrumbItem>
            <BreadcrumbLink href="/">Home</BreadcrumbLink>
          </BreadcrumbItem>
          <BreadcrumbSeparator />
          <BreadcrumbItem>
            <BreadcrumbPage>{obituary.source}</BreadcrumbPage>
          </BreadcrumbItem>
        </BreadcrumbList>
      </Breadcrumb>

      {/* Rest of page content */}
      <ObituaryDetail obituary={obituary} />
      <ObituaryNav previous={obituary.previous} next={obituary.next} />
    </main>
  )
}
```

**Visual Spec:**

```
Home > Gary Marcus

- Text: --text-secondary (muted)
- Separator: > or / character
- Home is clickable link
- Current page is not a link (just text)
- Position: top of content, left-aligned
- Margin bottom: 24px (mb-6)
```

**Acceptance Criteria:**
1. Breadcrumb shows "Home > [Source Name]"
2. "Home" links back to homepage
3. Current page (source name) is not clickable
4. Styled with muted colors
5. Positioned above obituary content

### 4.5 Story 5.5: Mobile Hybrid View

#### Component: MobileTimeline

**File:** `src/components/mobile/mobile-timeline.tsx`

```typescript
'use client'

import { useState } from 'react'
import { DensityBar } from './density-bar'
import { MobileCardList } from './mobile-card-list'
import { ObituaryModal } from '@/components/obituary/obituary-modal'
import type { Obituary } from '@/types/obituary'

interface MobileTimelineProps {
  obituaries: Obituary[]
  activeCategories: string[]
}

export function MobileTimeline({ obituaries, activeCategories }: MobileTimelineProps) {
  const [selectedObituary, setSelectedObituary] = useState<Obituary | null>(null)
  const [dateFilter, setDateFilter] = useState<{ start?: Date; end?: Date } | null>(null)

  // Filter obituaries by category and optional date range
  const filteredObituaries = obituaries.filter(ob => {
    // Category filter
    if (activeCategories.length > 0 &&
        !ob.categories.some(c => activeCategories.includes(c))) {
      return false
    }
    // Date filter from density bar tap
    if (dateFilter) {
      const date = new Date(ob.date)
      if (dateFilter.start && date < dateFilter.start) return false
      if (dateFilter.end && date > dateFilter.end) return false
    }
    return true
  })

  return (
    <div className="flex flex-col h-full">
      {/* Density Bar */}
      <DensityBar
        obituaries={obituaries}
        activeCategories={activeCategories}
        onPeriodSelect={setDateFilter}
        activePeriod={dateFilter}
      />

      {/* Card List */}
      <MobileCardList
        obituaries={filteredObituaries}
        onSelect={setSelectedObituary}
      />

      {/* Bottom Sheet Modal */}
      <ObituaryModal
        obituary={selectedObituary}
        isOpen={!!selectedObituary}
        onClose={() => setSelectedObituary(null)}
        side="bottom" // Mobile: sheet from bottom
      />
    </div>
  )
}
```

#### Component: DensityBar

**File:** `src/components/mobile/density-bar.tsx`

```typescript
'use client'

import { useMemo } from 'react'
import { cn } from '@/lib/utils/cn'
import type { Obituary } from '@/types/obituary'

interface DensityBarProps {
  obituaries: Obituary[]
  activeCategories: string[]
  onPeriodSelect: (period: { start: Date; end: Date } | null) => void
  activePeriod: { start?: Date; end?: Date } | null
}

export function DensityBar({
  obituaries,
  activeCategories,
  onPeriodSelect,
  activePeriod
}: DensityBarProps) {
  // Calculate density by month
  const { density, years, maxCount } = useMemo(() => {
    const counts: Record<string, number> = {}

    obituaries.forEach(ob => {
      // Apply category filter
      if (activeCategories.length > 0 &&
          !ob.categories.some(c => activeCategories.includes(c))) {
        return
      }

      const date = new Date(ob.date)
      const key = `${date.getFullYear()}-${date.getMonth()}`
      counts[key] = (counts[key] || 0) + 1
    })

    // Get year range
    const dates = obituaries.map(ob => new Date(ob.date))
    const minYear = Math.min(...dates.map(d => d.getFullYear()))
    const maxYear = Math.max(...dates.map(d => d.getFullYear()))
    const years = Array.from(
      { length: maxYear - minYear + 1 },
      (_, i) => minYear + i
    )

    // Build density array (12 months per year)
    const density: { month: string; year: number; count: number }[] = []
    years.forEach(year => {
      for (let month = 0; month < 12; month++) {
        const key = `${year}-${month}`
        density.push({
          month: key,
          year,
          count: counts[key] || 0
        })
      }
    })

    const maxCount = Math.max(...Object.values(counts), 1)

    return { density, years, maxCount }
  }, [obituaries, activeCategories])

  return (
    <div className="px-4 py-3 bg-[--bg-secondary] border-b border-[--border]">
      {/* Density Bars */}
      <div className="flex items-end gap-[2px] h-12 mb-2">
        {density.map(({ month, count }) => {
          const height = count > 0 ? Math.max(4, (count / maxCount) * 48) : 2
          return (
            <button
              key={month}
              className={cn(
                "flex-1 min-w-[2px] rounded-t transition-colors",
                count > 0
                  ? "bg-[--accent-primary] hover:bg-[--accent-primary]/80"
                  : "bg-[--border]"
              )}
              style={{ height: `${height}px` }}
              onClick={() => {
                const [year, monthNum] = month.split('-').map(Number)
                const start = new Date(year, monthNum, 1)
                const end = new Date(year, monthNum + 1, 0)
                onPeriodSelect({ start, end })
              }}
              aria-label={`${count} obituaries in ${new Date(Number(month.split('-')[0]), Number(month.split('-')[1])).toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}`}
            />
          )
        })}
      </div>

      {/* Year Labels */}
      <div className="flex justify-between text-xs text-[--text-muted]">
        {years.map(year => (
          <span key={year}>{year}</span>
        ))}
      </div>

      {/* Active period indicator */}
      {activePeriod && (
        <button
          onClick={() => onPeriodSelect(null)}
          className="mt-2 text-xs text-[--accent-primary] underline"
        >
          Clear date filter
        </button>
      )}
    </div>
  )
}
```

**Visual Spec:**

```
Mobile Hybrid View (< 768px)

┌─────────────────────────────────┐
│ AI Obituaries            247    │  <- Header with count
├─────────────────────────────────┤
│ ▁▂▅▇▅▃▂▁▂▄▆▅▃▂                 │  <- DensityBar (60px height)
│ 2022    2023    2024            │     Tap bar region = filter
├─────────────────────────────────┤
│ [All] [Cap] [Mkt] [AGI] [Dis]   │  <- CategoryFilter (sticky)
├─────────────────────────────────┤
│ ┌─────────────────────────────┐ │
│ │ "AI is just a bubble..."    │ │
│ │ Gary Marcus - Mar 14, 2023  │ │  <- ObituaryCard (stacked)
│ │ [Market/Bubble]             │ │
│ └─────────────────────────────┘ │
│ ┌─────────────────────────────┐ │
│ │ "This technology..."        │ │
│ │ TechCrunch - Jan 5, 2024    │ │
│ │ [Capability]                │ │
│ └─────────────────────────────┘ │
│           ...                   │
│ (vertical scroll)               │
└─────────────────────────────────┘

Tap card -> Bottom sheet modal
```

#### Component: MobileCardList

**File:** `src/components/mobile/mobile-card-list.tsx`

```typescript
'use client'

import { ObituaryCard } from '@/components/obituary/obituary-card'
import type { Obituary } from '@/types/obituary'

interface MobileCardListProps {
  obituaries: Obituary[]
  onSelect: (obituary: Obituary) => void
}

export function MobileCardList({ obituaries, onSelect }: MobileCardListProps) {
  if (obituaries.length === 0) {
    return (
      <div className="flex-1 flex items-center justify-center p-8 text-center">
        <p className="text-[--text-muted]">
          No obituaries match your filters.
          <br />
          <button
            onClick={() => window.location.href = '/'}
            className="text-[--accent-primary] underline mt-2"
          >
            Clear filters
          </button>
        </p>
      </div>
    )
  }

  return (
    <div className="flex-1 overflow-y-auto p-4 space-y-3">
      {obituaries.map(obituary => (
        <button
          key={obituary._id}
          onClick={() => onSelect(obituary)}
          className="w-full text-left"
        >
          <ObituaryCard obituary={obituary} compact />
        </button>
      ))}
    </div>
  )
}
```

**Acceptance Criteria:**
1a. Mobile view (< 768px) shows density bar
1b. Mobile view (< 768px) shows card list below density bar
2. Density bar shows visual distribution over time
3. Tapping density bar region filters to that time period
4. Cards show claim preview, source, date, category
5. Tapping card opens bottom sheet modal
6. Filter bar is sticky and scrollable
7. Vertical scroll works smoothly
8. Empty state shows helpful message

### 4.6 Story 5.6: Tablet & Desktop Polish

#### Hook: useBreakpoint

**File:** `src/lib/hooks/use-breakpoint.ts`

```typescript
'use client'

import { useEffect, useState } from 'react'
import type { Breakpoint } from '@/types/navigation'
import { BREAKPOINTS } from '@/types/navigation'

export function useBreakpoint(): Breakpoint {
  const [breakpoint, setBreakpoint] = useState<Breakpoint>('desktop')

  useEffect(() => {
    function updateBreakpoint() {
      const width = window.innerWidth
      if (width < BREAKPOINTS.tablet.min) {
        setBreakpoint('mobile')
      } else if (width < BREAKPOINTS.desktop.min) {
        setBreakpoint('tablet')
      } else {
        setBreakpoint('desktop')
      }
    }

    updateBreakpoint()
    window.addEventListener('resize', updateBreakpoint)
    return () => window.removeEventListener('resize', updateBreakpoint)
  }, [])

  return breakpoint
}

/**
 * Check if current breakpoint supports hover.
 */
export function useSupportsHover(): boolean {
  const [supportsHover, setSupportsHover] = useState(true)

  useEffect(() => {
    const mediaQuery = window.matchMedia('(hover: hover) and (pointer: fine)')
    setSupportsHover(mediaQuery.matches)

    const handler = (e: MediaQueryListEvent) => setSupportsHover(e.matches)
    mediaQuery.addEventListener('change', handler)
    return () => mediaQuery.removeEventListener('change', handler)
  }, [])

  return supportsHover
}
```

#### Homepage Layout Integration

**File:** `src/app/page.tsx` (modification)

```typescript
import { Suspense } from 'react'
import { getObituaries } from '@/lib/sanity/queries'
import { ScatterPlot } from '@/components/visualization/scatter-plot'
import { MobileTimeline } from '@/components/mobile/mobile-timeline'
import { CategoryFilter } from '@/components/filters/category-filter'
import { CountDisplay } from '@/components/obituary/count-display'
import { HomeClient } from './home-client'

interface Props {
  searchParams: { cat?: string }
}

export default async function HomePage({ searchParams }: Props) {
  const obituaries = await getObituaries()
  const activeCategories = searchParams.cat?.split(',').filter(Boolean) || []

  return (
    <main className="flex flex-col min-h-screen">
      {/* Desktop/Tablet: Full timeline */}
      <div className="hidden md:flex flex-col flex-1">
        <div className="flex-1 relative">
          <Suspense fallback={<TimelineSkeleton />}>
            <HomeClient
              obituaries={obituaries}
              activeCategories={activeCategories}
            />
          </Suspense>
        </div>
        <CategoryFilter className="fixed bottom-6 left-1/2 -translate-x-1/2 z-10" />
      </div>

      {/* Mobile: Hybrid view */}
      <div className="md:hidden flex flex-col flex-1">
        <Suspense fallback={<MobileSkeleton />}>
          <MobileTimeline
            obituaries={obituaries}
            activeCategories={activeCategories}
          />
        </Suspense>
        <CategoryFilter className="sticky bottom-0 z-10" />
      </div>
    </main>
  )
}
```

#### Tablet-Specific Adaptations

**Changes for Tablet (768px - 1023px):**

1. **ScatterPlot:**
   - Enable touch swipe for panning
   - Disable hover tooltips (tap to reveal instead)
   - Increase touch targets to 44px
   - Use tap-to-select instead of hover

2. **CategoryFilter:**
   - Horizontally scrollable pill container
   - Larger touch targets (44px height)
   - Sticky at bottom

3. **CountDisplay:**
   - Move to header area (smaller size)
   - Reduce font size to 2.5rem (40px)

**CSS Implementation:**

```css
/* src/app/globals.css additions */

/* Tablet-specific styles */
@media (min-width: 768px) and (max-width: 1023px) {
  /* Larger touch targets */
  .filter-pill {
    min-height: 44px;
    padding: 0.75rem 1rem;
  }

  /* Timeline dot touch targets */
  .timeline-dot {
    /* Visual size stays at 14px */
    /* Touch target extends via padding */
    padding: 15px;
    margin: -15px;
  }
}

/* Desktop: enable hover features */
@media (hover: hover) and (pointer: fine) {
  .timeline-dot:hover {
    transform: scale(1.3);
  }

  .timeline-tooltip {
    display: block;
  }
}

/* Touch devices: tap to reveal */
@media (hover: none) {
  .timeline-dot:focus {
    transform: scale(1.3);
  }

  .timeline-tooltip {
    /* Show on focus instead of hover */
    display: none;
  }

  .timeline-dot:focus + .timeline-tooltip {
    display: block;
  }
}
```

**Acceptance Criteria:**
1. Desktop (1024px+): Full horizontal timeline with hover
2. Tablet (768-1023px): Horizontal timeline with touch swipe, tap tooltips
3. Mobile (< 768px): Hybrid density bar + card list view
4. Touch targets minimum 44px on touch devices
5. Count display adapts size per breakpoint
6. Filter bar position adapts per breakpoint
7. Smooth transitions between breakpoints (CSS media queries)

---

## 5. API Contracts

### 5.1 Sanity GROQ Queries

#### Get Obituary with Navigation

```groq
// src/lib/sanity/queries.ts

import { groq } from 'next-sanity'

export const obituaryWithNavQuery = groq`
*[_type == "obituary" && slug.current == $slug][0] {
  _id,
  "slug": slug.current,
  claim,
  source,
  sourceUrl,
  date,
  categories,
  context,

  "previous": *[_type == "obituary" && date < ^.date] | order(date desc) [0] {
    "slug": slug.current,
    "claimPreview": claim[0...80] + "...",
    source,
    date
  },

  "next": *[_type == "obituary" && date > ^.date] | order(date asc) [0] {
    "slug": slug.current,
    "claimPreview": claim[0...80] + "...",
    source,
    date
  }
}
`

export async function getObituaryWithNav(slug: string) {
  return client.fetch<ObituaryWithNav>(obituaryWithNavQuery, { slug })
}
```

#### Response Type

```typescript
interface ObituaryWithNav extends Obituary {
  previous: AdjacentObituary | null
  next: AdjacentObituary | null
}
```

---

## 6. Non-Functional Requirements

### 6.1 Performance Requirements

| Metric | Target | Implementation |
|--------|--------|----------------|
| Mobile First Paint | < 1.5s | SSG + lightweight mobile components |
| Touch Response | < 50ms | Debounced handlers, optimistic UI |
| Position Restore | < 100ms | sessionStorage read is synchronous |
| Layout Shift | CLS < 0.1 | Reserve space for density bar |
| Scroll FPS | 60fps | CSS transforms, no layout thrashing |

### 6.2 Security Requirements

| Concern | Implementation |
|---------|----------------|
| sessionStorage | No sensitive data stored |
| URL State | Filter state only (categories), no user data |
| Navigation | Client-side routing via Next.js Link |

### 6.3 Accessibility Requirements (WCAG 2.1 AA)

| Element | Requirement | Implementation |
|---------|-------------|----------------|
| Breadcrumb | Semantic nav element | `<nav aria-label="Breadcrumb">` |
| Prev/Next | Keyboard accessible | ArrowLeft/Right keys, focus visible |
| Mobile Cards | Touch targets | 44px minimum tap area |
| Density Bar | Screen reader | aria-labels for each bar segment |
| Modal Side | Announced | aria-modal, focus trap |

### 6.4 Browser Support

| Browser | Version | Notes |
|---------|---------|-------|
| Chrome | Last 2 | Full support |
| Safari | Last 2 | Full support |
| Firefox | Last 2 | Full support |
| Edge | Last 2 | Full support |
| Mobile Safari | iOS 15+ | Touch gestures |
| Chrome Android | Last 2 | Touch gestures |

---

## 7. Testing Strategy

### 7.1 Unit Tests

```typescript
// tests/unit/lib/hooks/use-timeline-position.test.ts

import { renderHook, act } from '@testing-library/react'
import { useTimelinePosition } from '@/lib/hooks/use-timeline-position'

describe('useTimelinePosition', () => {
  beforeEach(() => {
    sessionStorage.clear()
  })

  it('returns null position when storage is empty', () => {
    const { result } = renderHook(() => useTimelinePosition())
    expect(result.current.position).toBeNull()
    expect(result.current.wasRestored).toBe(false)
  })

  it('saves and retrieves position', () => {
    const { result } = renderHook(() => useTimelinePosition())

    act(() => {
      result.current.savePosition({ scrollX: 100, zoom: 1.5 })
    })

    expect(result.current.position?.scrollX).toBe(100)
    expect(result.current.position?.zoom).toBe(1.5)
  })

  it('restores position from sessionStorage', () => {
    // Pre-populate storage
    sessionStorage.setItem('timeline-position', JSON.stringify({
      scrollX: 200,
      zoom: 2.0,
      timestamp: Date.now()
    }))

    const { result } = renderHook(() => useTimelinePosition())

    expect(result.current.position?.scrollX).toBe(200)
    expect(result.current.wasRestored).toBe(true)
  })

  it('ignores expired positions', () => {
    // Set position from 2 hours ago
    sessionStorage.setItem('timeline-position', JSON.stringify({
      scrollX: 300,
      zoom: 1.0,
      timestamp: Date.now() - (2 * 60 * 60 * 1000)
    }))

    const { result } = renderHook(() => useTimelinePosition())

    expect(result.current.position).toBeNull()
    expect(result.current.wasRestored).toBe(false)
  })
})
```

### 7.2 Component Tests

```typescript
// tests/components/obituary/obituary-nav.test.tsx

import { render, screen, fireEvent } from '@testing-library/react'
import { ObituaryNav } from '@/components/obituary/obituary-nav'

describe('ObituaryNav', () => {
  const mockPrevious = {
    slug: 'prev-slug',
    claimPreview: 'Previous claim...',
    source: 'Previous Source',
    date: '2023-01-01'
  }

  const mockNext = {
    slug: 'next-slug',
    claimPreview: 'Next claim...',
    source: 'Next Source',
    date: '2023-03-01'
  }

  it('renders previous and next links', () => {
    render(<ObituaryNav previous={mockPrevious} next={mockNext} />)

    expect(screen.getByText('Previous')).toBeInTheDocument()
    expect(screen.getByText('Previous Source')).toBeInTheDocument()
    expect(screen.getByText('Next')).toBeInTheDocument()
    expect(screen.getByText('Next Source')).toBeInTheDocument()
  })

  it('renders empty space when no previous', () => {
    render(<ObituaryNav previous={null} next={mockNext} />)

    expect(screen.queryByText('Previous')).not.toBeInTheDocument()
    expect(screen.getByText('Next')).toBeInTheDocument()
  })

  it('navigates on arrow key press', () => {
    render(<ObituaryNav previous={mockPrevious} next={mockNext} />)

    // Mock window.location
    delete (window as any).location
    window.location = { href: '' } as any

    fireEvent.keyDown(document, { key: 'ArrowLeft' })
    expect(window.location.href).toBe('/obituary/prev-slug')

    fireEvent.keyDown(document, { key: 'ArrowRight' })
    expect(window.location.href).toBe('/obituary/next-slug')
  })
})
```

### 7.2.5 Visual Regression Testing

Use Playwright screenshot comparison for visual regression detection:

```typescript
// tests/e2e/visual-regression.spec.ts

test('visual regression: mobile breakpoint', async ({ page }) => {
  // Set mobile viewport
  await page.setViewportSize({ width: 375, height: 812 })
  await page.goto('/')

  // Take screenshot and compare against baseline
  await expect(page).toHaveScreenshot('mobile-home.png')
})

test('visual regression: tablet breakpoint', async ({ page }) => {
  await page.setViewportSize({ width: 768, height: 1024 })
  await page.goto('/')

  await expect(page).toHaveScreenshot('tablet-home.png')
})

test('visual regression: density bar layout', async ({ page }) => {
  await page.setViewportSize({ width: 375, height: 812 })
  await page.goto('/')

  // Isolate density bar
  const densityBar = page.locator('[data-testid="density-bar"]')
  await expect(densityBar).toHaveScreenshot('density-bar.png')
})
```

### 7.2.6 Accessibility Testing

Use axe-playwright for automated accessibility checks:

```typescript
// tests/e2e/accessibility.spec.ts

import { injectAxe, checkA11y } from 'axe-playwright'

test('accessibility: homepage', async ({ page }) => {
  await page.goto('/')

  await injectAxe(page)
  await checkA11y(page, null, {
    detailedReport: true,
    detailedReportOptions: { html: true }
  })
})

test('accessibility: obituary page', async ({ page }) => {
  await page.goto('/obituary/some-slug')

  await injectAxe(page)
  await checkA11y(page, null)
})

test('keyboard navigation: focus indicators visible', async ({ page }) => {
  await page.goto('/obituary/some-slug')

  // Tab through navigation
  await page.keyboard.press('Tab')
  const focused = await page.locator(':focus')

  // Ensure focus visible (outline or similar)
  const outline = await focused.evaluate(el => {
    return window.getComputedStyle(el).outline
  })
  expect(outline).not.toBe('none')
})
```

### 7.3 E2E Tests

```typescript
// tests/e2e/navigation.spec.ts

import { test, expect } from '@playwright/test'

test.describe('Navigation Flow', () => {
  test('modal to full page transition', async ({ page }) => {
    await page.goto('/')

    // Click a timeline dot
    await page.locator('[data-testid="scatter-point"]').first().click()

    // Modal should open
    await expect(page.locator('[role="dialog"]')).toBeVisible()

    // Click "View full page"
    await page.getByRole('link', { name: /view full page/i }).click()

    // Should navigate to obituary page
    await expect(page).toHaveURL(/\/obituary\//)

    // Breadcrumb should be visible
    await expect(page.getByRole('navigation', { name: /breadcrumb/i })).toBeVisible()
  })

  test('previous/next navigation', async ({ page }) => {
    await page.goto('/obituary/some-slug')

    // Click next
    const initialUrl = page.url()
    await page.getByRole('link', { name: /next/i }).click()

    // URL should change
    await expect(page).not.toHaveURL(initialUrl)
    await expect(page).toHaveURL(/\/obituary\//)
  })

  test('position preservation', async ({ page }) => {
    await page.goto('/')

    // Scroll timeline
    await page.locator('[data-testid="scatter-plot"]').evaluate(el => {
      el.scrollLeft = 500
    })

    // Open an obituary
    await page.locator('[data-testid="scatter-point"]').first().click()
    await page.getByRole('link', { name: /view full page/i }).click()

    // Go back
    await page.goBack()

    // Position should be restored
    const scrollLeft = await page.locator('[data-testid="scatter-plot"]').evaluate(
      el => el.scrollLeft
    )
    expect(scrollLeft).toBeGreaterThan(400)
  })

  test('mobile hybrid view', async ({ page }) => {
    // Set mobile viewport
    await page.setViewportSize({ width: 375, height: 812 })
    await page.goto('/')

    // Density bar should be visible
    await expect(page.locator('[data-testid="density-bar"]')).toBeVisible()

    // Card list should be visible
    await expect(page.locator('[data-testid="mobile-card-list"]')).toBeVisible()

    // Timeline should be hidden
    await expect(page.locator('[data-testid="scatter-plot"]')).not.toBeVisible()

    // Tap a card
    await page.locator('[data-testid="obituary-card"]').first().click()

    // Bottom sheet should open
    await expect(page.locator('[data-testid="bottom-sheet"]')).toBeVisible()
  })

  test('keyboard navigation chain (prev/next sequence)', async ({ page }) => {
    // Start at an obituary page
    await page.goto('/obituary/some-slug')

    // Navigate forward with arrow key
    await page.keyboard.press('ArrowRight')
    const url1 = page.url()
    await expect(page).toHaveURL(/\/obituary\//)

    // Continue forward
    await page.keyboard.press('ArrowRight')
    const url2 = page.url()
    await expect(page).not.toHaveURL(url1) // Should be different obituary
    await expect(page).toHaveURL(/\/obituary\//)

    // Go backward
    await page.keyboard.press('ArrowLeft')
    await expect(page).toHaveURL(url1) // Should return to previous page
  })
})
```

---

## 8. Acceptance Criteria Summary

### Story 5.1: Modal to Full Page Transition
- [x] AC1: "View full page" button visible at bottom of modal
- [x] AC2: Button styled as primary action (gold background)
- [x] AC3: Clicking navigates to `/obituary/[slug]`
- [x] AC4: Modal closes during navigation
- [x] AC5: Focus moves to main content on new page

### Story 5.2: Previous/Next Navigation
- [x] AC1: Previous links to older obituary (chronological)
- [x] AC2: Next links to newer obituary (chronological)
- [x] AC3: Missing direction shows empty space
- [x] AC4: Arrow keys navigate (Left=prev, Right=next)
- [x] AC5: Source name shown as label
- [x] AC6: Hover state with gold accent

### Story 5.3: Position Preservation
- [x] AC1: Position saved on scroll/zoom change
- [x] AC2: Position restored when returning to homepage
- [x] AC3: Position expires after 1 hour
- [x] AC4: Browser back preserves position
- [x] AC5: Works with filter state in URL

### Story 5.4: Breadcrumb Navigation
- [x] AC1: Shows "Home > [Source Name]"
- [x] AC2: "Home" links to homepage
- [x] AC3: Current page not clickable
- [x] AC4: Muted color styling
- [x] AC5: Positioned above obituary content

### Story 5.5: Mobile Hybrid View
- [x] AC1a: Mobile (< 768px) shows density bar
- [x] AC1b: Mobile (< 768px) shows card list below density bar
- [x] AC2: Density bar shows visual distribution
- [x] AC3: Tapping density bar filters by date
- [x] AC4: Cards show claim, source, date, category
- [x] AC5: Tap card opens bottom sheet modal
- [x] AC6: Filter bar sticky and scrollable
- [x] AC7: Smooth vertical scroll
- [x] AC8: Empty state with helpful message

### Story 5.6: Tablet & Desktop Polish
- [x] AC1: Desktop shows full horizontal timeline with hover
- [x] AC2: Tablet shows timeline with touch swipe
- [x] AC3: Touch targets minimum 44px
- [x] AC4: Count display adapts per breakpoint
- [x] AC5: Filter bar position adapts
- [x] AC6: Smooth breakpoint transitions (CLS < 0.1 during viewport resize)

---

## 9. Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Position restoration feels jarring | Medium | Low | Use smooth scroll to saved position |
| Mobile density bar hard to tap | Medium | Medium | Ensure tap targets are large enough |
| sessionStorage unavailable | Low | Low | Graceful degradation - just don't preserve |
| Prev/next slow on large datasets | Low | Medium | GROQ query is already optimized with limits |
| Touch swipe conflicts with browser | Medium | Medium | Use `touch-action` CSS property |

---

## 10. Dependencies Graph

```
Story Dependency Order:

                    [Epic 4 Complete]
                          │
         ┌────────────────┼────────────────┐
         │                │                │
         ▼                ▼                ▼
    [5.3 Position]   [5.1 Modal]     [5.4 Breadcrumb]
    Preservation      Transition       Navigation
         │                │                │
         │                ▼                │
         │         [5.2 Prev/Next]         │
         │                │                │
         └────────────────┼────────────────┘
                          │
                          ▼
                   [5.5 Mobile]
                    Hybrid View
                          │
                          ▼
                   [5.6 Tablet/Desktop]
                        Polish

Parallel Work Possible:
- 5.1, 5.3, 5.4 can start immediately (no dependencies on each other)
- 5.2 depends on 5.1 (needs modal changes)
- 5.5 depends on filter state (Epic 4) but can start after 5.1
- 5.6 is final polish after mobile is done
```

---

## 11. Implementation Notes

### 11.1 Mobile-First Implementation Order

1. Start with mobile hybrid view (5.5) - defines the alternative experience
2. Implement position preservation (5.3) - works on both views
3. Add modal transition (5.1) - simple enhancement
4. Add prev/next navigation (5.2) - obituary page feature
5. Add breadcrumbs (5.4) - simple addition
6. Polish responsive breakpoints (5.6) - final refinements

### 11.2 Key Technical Decisions

1. **sessionStorage over URL**: Position state is ephemeral and shouldn't be shared
2. **CSS media queries over JS**: Breakpoint switching is more performant
3. **Touch-action CSS**: Prevents swipe conflicts with browser gestures
4. **Debounced position saving**: Prevents storage spam during continuous scroll

### 11.3 Files Summary

**New Files (10):**
- `src/components/mobile/mobile-timeline.tsx`
- `src/components/mobile/density-bar.tsx`
- `src/components/mobile/mobile-card-list.tsx`
- `src/components/obituary/obituary-nav.tsx`
- `src/components/ui/breadcrumb.tsx` (shadcn)
- `src/lib/hooks/use-timeline-position.ts`
- `src/lib/hooks/use-breakpoint.ts`
- `src/types/navigation.ts`
- `tests/unit/lib/hooks/use-timeline-position.test.ts`
- `tests/e2e/navigation.spec.ts`

**Modified Files (6):**
- `src/app/page.tsx` (responsive layout)
- `src/app/obituary/[slug]/page.tsx` (breadcrumb, nav)
- `src/components/obituary/obituary-modal.tsx` (view full page button)
- `src/components/visualization/scatter-plot.tsx` (position save/restore)
- `src/lib/sanity/queries.ts` (nav query)
- `src/app/globals.css` (responsive styles)

---

_Generated by Epic Tech Context Specialist_
_Date: 2025-11-30_
_For: Luca_

---

**Document Status:** Complete
**Ready for Story Creation:** YES
